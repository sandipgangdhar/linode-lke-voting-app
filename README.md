# 🗳️ Linode LKE Voting App Demo

A complete Terraform-based demo showcasing a scalable Kubernetes Voting App deployed on **Linode Kubernetes Engine (LKE)** with:

- 🔄 Horizontal Pod Autoscaling (HPA)
- 🧠 Metrics Server Patch
- 🗳️ Voting app (Redis, Flask, Worker, PostgreSQL)
- ☁️ Linode Managed PostgreSQL
- 📦 Kubernetes-native init job for DB setup

---

## 🚀 Features

| Feature                        | Description                                                  |
|-------------------------------|--------------------------------------------------------------|
| 🌐 LKE Cluster                 | Linode Kubernetes Engine with 3 worker nodes                |
| 🗳️ Voting App                 | Classic Flask-based voting app with Redis + PostgreSQL      |
| ⚙️ Terraform Automation       | Full Infra & App lifecycle via Terraform                    |
| 📈 HPA Enabled                 | CPU-based autoscaling of `vote`, `result`, `worker` pods    |
| 📊 Metrics Server Patch       | Secure port (4443), liveness/readiness fix for HPA          |
| 🔐 Secret Management           | PostgreSQL credentials injected as Kubernetes Secret        |
| 🧩 DB Init Job                | K8s Job creates DB & tables during deployment               |

---

## 📁 Project Structure

```
linode-lke-voting-app/
├── terraform/
│   └── voting-app/
│       ├── vote-deployment.yaml
│       ├── result-deployment.yaml
│       ├── worker-deployment.yaml
│       ├── redis-deployment.yaml
│       ├── db-init-job.yaml         # 🔁 Creates DB + table
│       ├── hpa.yaml
│       ├── services.yaml
│       ├── vote-service.yaml
│       └── result-service.yaml
├── main.tf                         # 🧠 Terraform logic
├── variables.tf                    # 📥 Input variables
├── outputs.tf                      # 📤 Useful outputs
└── kubeconfig                      # 🔑 Auto-generated by Terraform
```

---

## 🧰 Prerequisites

- ✅ [Terraform](https://www.terraform.io/downloads.html) v1.3+
- ✅ [kubectl](https://kubernetes.io/docs/tasks/tools/) installed & in `$PATH`
- ✅ `linode-cli` configured with your access token
- ✅ Terraform Cloud or local `TF_VAR_linode_token` set

---

## 🚀 How to Deploy

### 1. Clone the Repo

```bash
git clone https://github.com/YOUR-USERNAME/linode-lke-voting-app.git
cd linode-lke-voting-app
```

### 2. Set your variables

Update the `terraform.tfvars` file or pass as `-var` flags:

```hcl
linode_token = "your-linode-token"
region       = "your-region"         # e.g. "ap-south"
cluster_label = "voting-cluster"
pg_database   = "voting"
```

### 3. Initialize and Apply

```bash
terraform init
terraform apply -auto-approve
```

---

## 🌐 Access the App

Get the external IP of the vote service:

```bash
kubectl get svc vote -o wide
```

Visit `http://<EXTERNAL-IP>` in your browser to cast votes.

---

## 🔬 Testing HPA

### Simulate Load:

```bash
seq 1 20 | xargs -n1 -P20 -I{} bash -c 'while true; do curl -s http://<EXTERNAL-IP> -d "vote=a" > /dev/null; done'
```

### Watch Auto-scaling:

```bash
kubectl get hpa -w
```

---

## 🧹 Cleanup

```bash
terraform destroy -auto-approve
```

---

## 📝 License

This project is open-source and available under the [MIT License](LICENSE).

---

## 🙌 Acknowledgements

Built using:
- [Terraform](https://terraform.io)
- [Kubernetes](https://kubernetes.io)
- [Linode LKE](https://www.linode.com/products/kubernetes/)
- [Docker Voting App](https://github.com/dockersamples/example-voting-app)

---

> 💡 Maintained by [@sandipgangdhar](https://github.com/sandipgangdhar)
